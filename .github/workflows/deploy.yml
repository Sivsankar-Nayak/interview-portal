name: Build and Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (CI)
        run: npm ci

      - name: Generate TOC
        run: npm run generate:toc

      - name: Create deployment archive (use git-archive; include generated files)
        run: |
          # If the generator produced files, add/commit them locally so git-archive includes them
          if [ -f src/data/thereact-toc.json ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add src/data/thereact-toc.json
            git commit -m "ci: include generated TOC" || echo "nothing to commit"
          fi

          # Create a stable archive from the current HEAD
          git archive --format=tar.gz -o site.tar.gz HEAD

      - name: Upload archive to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          port: 22
          source: "site.tar.gz"
          target: ${{ secrets.VPS_APP_DIR }}

      - name: Deploy on VPS (extract, install, build, pm2 restart)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            cd ${{ secrets.VPS_APP_DIR }}
            # extract archive (overwrites files)
            tar -xzf site.tar.gz --overwrite
            rm -f site.tar.gz

            # ensure correct Node version on server (use n or nvm if available)
            echo "Deploying to $(pwd) on $(hostname)"

            # install full deps and build
            npm ci --production=false
            npm run build

            # ensure pm2 exists and restart the app
            if ! command -v pm2 >/dev/null 2>&1; then
              npm i -g pm2
            fi

            # Prefer ecosystem config if present, fallback to named pm2 restart
            if [ -f ecosystem.config.js ]; then
              pm2 startOrRestart ecosystem.config.js --env production
            else
              pm2 restart interview-portal || pm2 start npm --name "interview-portal" -- start
            fi